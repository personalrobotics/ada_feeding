<root BTCPP_format="4" main_tree_to_execute="AcquisitionRoot">
  <!-- Subtree Includes -->
  <include path="./helpers.xml"/>
  <include path="./transfer.xml"/>

  <!-- Acquisition-Only -->
  <BehaviorTree ID="AcquisitionRoot">
    <Sequence name="AcquisitionRootSeq">

      <SubTree ID="ParamToWorld" obj_name="table" /> 
      <SubTree ID="ParamToWorld" obj_name="plate" />

      <!-- Give Velocity Headroom -->
      <RosGetVecD param="velocityLimits/standard" target="{vel_standard}" />
      <AdaSetLimits velocity="{vel_standard}" />

      <!-- Move Above Plate -->
      <RosGetVecD param="configs/wheelchair/above_plate" target="{config}" />
      <SubTree ID="MoveToConfig" config="{config}" worldCollision="{TRUE}" />

      <!-- Close Hand SIM ONLY -->
      <AdaHandConfig config="1.3;1.3" />

      <!-- Ask for Food -->
      <RosSubString name="AskForFood" topic="food_request" target="{food_name}" />

      <!-- Get Action Action -->
      <RosGetBool param="posthoc/active" target="{is_online}" default="false" />
      <Fallback>
        <Sequence name="GetActionOnline" _failureIf="is_online==false">
           <RosGetI param="posthoc/index_offset" target="{action_idx_offset}" default="0" />
           <RosGetString param="posthoc/image_topic" target="{context_topic}" />
           <RosSubImage topic="{context_topic}" target="{context}" />
           <AcquisitionGetActionOnline context="{context}" probabilities="{action_probs}" action_index="{action_idx}" />
           <Script code=" action_idx=action_idx+action_idx_offset" />
        </Sequence>
        <Sequence name="GetActionManual">
          <Script code=" is_online=false; action_idx_offset=0 " />
          <RosSubI name="AskForAction" topic="action_select" target="{action_idx}" />
        </Sequence>
      </Fallback>

      <!-- Load Action Library -->
      <RosGetParam param="action_selection/actions" target="{library}" />
      <AcquisitionGetAction library="{library}" index="{action_idx}" target="{action}" />

      <!-- Perceive Food -->
      <RetryUntilSuccessful num_attempts="-1">
        <PerceiveFood timeout="3" objects="{foods}" />
      </RetryUntilSuccessful>

      <!-- Rank Foods Based on Distance to Fork -->
      <RankDistance objects="{foods}" output="{food}" />

      <!-- Acquisition -->
      <SubTree ID="BiteAcquisition" food="{food}" action="{action}" context="{context}" action_probs="{action_probs}" is_online="{is_online}" action_idx="{action_idx}" action_idx_offset="{action_idx_offset}" />

      <!-- Transfer -->
      <SubTree ID="BiteTransfer" />

    </Sequence>
  </BehaviorTree>

  <!-- Bite Acquisition -->
  <BehaviorTree ID="BiteAcquisition">
    <RetryUntilSuccessful num_attempts="3">
      <Sequence name="AcquisitionSeq">
        <AdaSetVFParams />
        <!-- Scripting constants -->
        <Script code=" TRUE:=true; FALSE:=false " />
        <Script code=" X:=0; Y:=1; Z:=2; PI:=3.1415926535 " />

        <!-- Try Redetect Foods -->
        <!--
        <ForceSuccess>
          <Sequence>
            <PerceiveFood name_filter="{food_name}" timeout="1" objects="{foods}" />
            <RankDistance objects="{foods}" nearestTo="{food}" output="{food}" />
          </Sequence>
        </ForceSuccess>
        -->

        <!-- Move Above -->
        <SetFTThreshold preset="standard" />
        <AcquisitionUnpackAction action="{action}" rotate_pref="{rotate}" />
        <Fallback>
          <!-- Normal -->
          <Sequence>
            <FrameFromObject object="{food}" align_idx="{Z}" rotate_aligned="{rotate}" frame="{food_frame}" fixed_z="0.22" />
            <ConfigMoveAbove obj_transform="{food_frame}" action="{action}" orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" />
            <AdaPlanToPose orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" worldCollision="{TRUE}" traj="{traj}" />
          </Sequence>
          <!-- Flipped -->
          <Sequence>
            <Script code=" rotate += PI " />
            <FrameFromObject object="{food}" align_idx="{Z}" rotate_aligned="{rotate}" frame="{food_frame}" fixed_z="0.22" />
            <ConfigMoveAbove obj_transform="{food_frame}" action="{action}" orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" />
            <AdaPlanToPose orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" worldCollision="{TRUE}" traj="{traj}" />
          </Sequence>
          <!-- Yaw Agnostic -->
          <Sequence>
            <FrameFromObject object="{food}" align_idx="{Z}" rotate_aligned="{rotate}" frame="{food_frame}" fixed_z="0.22" />
            <ConfigMoveAbove obj_transform="{food_frame}" action="{action}" yaw_agnostic="{TRUE}" orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" />
            <AdaPlanToPose orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" worldCollision="{TRUE}" traj="{traj}" />
          </Sequence>
        </Fallback>
        <AdaExecuteTrajectory name="MoveAbove" traj="{traj}" />
        <!-- TODO (low-pri): add above logic to entire action by simulating action -->

        <!-- Move Into -->
        <RosGetD param="move_into/overshoot" target="{overshoot}" default="0.0" />
        <RosGetVecD param="move_into/world_off" target="{world_off}" default="0.0;0.0;0.0" />
        <ConfigMoveInto obj_transform="{food_frame}" action="{action}" overshoot="{overshoot}" world_off="{world_off}" offset="{approach}" />
        <AcquisitionUnpackAction action="{action}" pre_force="{force}" pre_torque="{torque}" />
        <SetFTThreshold force="{force}" torque="{torque}" retare="true" />
        <!-- FT Sensor Trip is Okay -->
        <AdaPlanToPoseOffset name="PlanOffsetInto" offset="{approach}" rotation="0.0;0.0;0.0" worldCollision="{FALSE}" traj="{traj}" />
        <FTStartDataCollect _skipIf="is_online==false" />
        <ForceSuccess>
            <AdaExecuteTrajectory name="MoveInto" traj="{traj}" />
        </ForceSuccess>

        <!-- Move Within -->
        <RosGetParam param="move_within/vf_params" target="{vf_params}" />
        <AdaSetVFParams vfparam="{vf_params}" />
        <RosGetD param="move_within/z_min" target="{z_min}" default="0.0" />
        <ConfigTwist action="{action}" is_extraction="{FALSE}" approach="{approach}" z_min="{z_min}" obj_transform="{food_frame}" offset="{offset}" rotation="{rotation}" null_motion="{nulltwist}" />
        <!-- Skip below if null motion -->
        <Sequence _skipIf="nulltwist==true">
          <AcquisitionUnpackAction action="{action}" grasp_force="{force}" grasp_torque="{torque}" />
          <SetFTThreshold force="{force}" torque="{torque}" />
          <!-- FT Sensor Trip is Okay -->
          <AdaPlanToPoseOffset name="PlanTwistWithin" offset="{offset}" rotation="{rotation}" worldCollision="{FALSE}" traj="{traj}" />
          <ForceSuccess><AdaExecuteTrajectory name="MoveWithin" traj="{traj}" /></ForceSuccess>
        </Sequence>

        <FTStopDataCollect _skipIf="is_online==false" />

        <!-- Move Out -->
        <RosGetParam param="move_out/vf_params" target="{vf_params}" />
        <AdaSetVFParams vfparam="{vf_params}" />
        <RosGetD param="move_out/z_max" target="{z_max}" />
        <ConfigTwist action="{action}" is_extraction="{TRUE}" approach="{approach}" z_max="{z_max}" obj_transform="{food_frame}" offset="{offset}" rotation="{rotation}" />
        <AcquisitionUnpackAction action="{action}" ext_force="{force}" ext_torque="{torque}" />
        <SetFTThreshold force="{force}" torque="{torque}" />
        <AdaPlanToPoseOffset name="PlanTwistOut" offset="{offset}" rotation="{rotation}" worldCollision="{FALSE}" traj="{traj}" />
        <AdaExecuteTrajectory name="MoveOut" traj="{traj}" />

        <!-- Check Acquisition -->
        <RosSubBool name="CheckAcquire" topic="check_acquire" target="{acquired}" />
        <SetFTThreshold preset="standard" retare="true" />

        <!-- Online Update -->
        <Sequence name="PublishLosSeq" _skipIf="is_online==false">
          <FTGetData data="{posthoc}" />
          <Script code=" action_idx=action_idx - action_idx_offset " />
          <RosSubD name="GetLoss" topic="get_loss" target="{loss}" />
          <!--<Script code=" loss:=0.0 " />
          <Script _skipIf="acquired==true" code=" loss=1.0 " /> -->
          <AcquisitionPublishLossOnline context="{context}" posthoc="{posthoc}" action_index="{action_idx}" probabilities="{action_probs}" loss="{loss}" />
        </Sequence>

        <!-- Return Success/Failure -->
        <Failure _successIf="acquired==true" />
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>
</root>