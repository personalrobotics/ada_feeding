<root main_tree_to_execute = "Root" >
  <!-- Subtree Includes -->

  <!-- Watchdog -->
  <BehaviorTree ID="Root">
    <ReactiveSequence>
      <CheckWatchdog />
      <SubTree ID="Meal"/>
    </ReactiveSequence>
  </BehaviorTree>

  <!-- Main Meal Sequence -->
  <BehaviorTree ID="Meal">
    <Sequence name="MealSeq">
      <!-- Scripting constants -->
      <Script code=" TRUE:=true " />
      <Script code=" FALSE:=false " />

      <!-- Setup Workspace -->
<!--       <SubTree ID="ParamToWorld" obj_name="wheelchair" /> 
      <SubTree ID="ParamToWorld" obj_name="table" /> 
      <SubTree ID="ParamToWorld" obj_name="plate" /> -->

      <!-- Setup ADA -->
      <RosGetVecD param="velocityLimits/standard" target="{vel_standard}" />
      <AdaSetLimits velocity="{vel_standard}" />

      <!-- <Talk say="Hello! My name is Ayduh, it's a pleasure to serve you today!" /> -->

      <!-- Bite Sequence -->
      <Repeat num_cycles="-1">
      <Sequence name="BiteSeq">
        <!-- Init FT Sensor -->
        <!-- <SetFTThreshold preset="standard" /> -->

        <!-- Move Above Plate -->
        <RosGetVecD param="configs/wheelchair/above_plate" target="{config}" />
        <SubTree ID="MoveToConfig" config="{config}" worldCollision="{TRUE}" />
        
        <!-- Request Food -->
        <!-- <Talk say="What food would you like?" /> -->
        <RosSubString topic="food_request" target="{food_name}" />
        <Script code=" statement := 'One '+food_name+' coming right up!'" />
        <!-- <Talk say="{statement}" /> -->

        <!-- Failure Just Restarts -->
        <ForceSuccess>
        <Sequence name="FeedBite">
          <!-- Acquisition -->
          <PerceiveFood name_filter="{food_name}" timeout="5" objects="{foods}" />
          <ConfigActionSelect foods="{foods}" action="{action}" />
          <RetryUntilSuccessful num_attempts="3">
            <SubTree ID="AcquisitionAction" food_name="{food_name}" foods="{foods}" action="{action}" />
          </RetryUntilSuccessful>
        

          <!-- Transfer -->

          <!-- Move in Front of Person -->
          <!-- <SetFTThreshold preset="standard" /> -->
          <RosGetVecD param="configs/wheelchair/in_front_person" target="{config}" />
          <SubTree ID="MoveToConfig" config="{config}" worldCollision="{TRUE}" />

          <SwitchControllerBiteTransfer/>
          <RosSubBool topic="transfer_over" target="{transfer_over}" />

          <SwitchControllerBiteAcquisition/>

        </Sequence>
        </ForceSuccess>
      </Sequence>
      </Repeat>
    </Sequence>
  </BehaviorTree>

  <!-- Pull from Param Server and add to World -->
  <BehaviorTree ID="ParamToWorld">
    <Sequence name="ParamToWorldSeq">
      <Script code=" urdfParam:='workspace/'+obj_name+'/urdf' " />
      <RosGetString param="{urdfParam}" target="{urdf}" />

      <Script code=" posParam:='workspace/'+obj_name+'/pos' " />
      <RosGetVecD param="{posParam}" target="{pos}" />

      <Script code=" quatParam:='workspace/'+obj_name+'/quat' " />
      <RosGetVecD param="{quatParam}" target="{quat}" />
      <WorldAddUpdate urdfUri="{urdf}" pos="{pos}" quat="{quat}" name="{obj_name}" />
    </Sequence>
  </BehaviorTree>

  <!-- Movement Trees -->
  <BehaviorTree ID="MoveToConfig">
    <Sequence name="MoveToConfigSeq">
      <AdaPlanToConfig config="{config}" worldCollision="{worldCollision}" traj="{traj}" />
      <AdaExecuteTrajectory traj="{traj}" />
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="MoveToOffset">
    <Sequence name="MoveToOffsetSeq">
      <AdaPlanToOffset offset="{offset}" worldCollision="{worldCollision}" traj="{traj}" />
      <AdaExecuteTrajectory traj="{traj}" />
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="MoveToPose">
    <Sequence name="MoveToPoseSeq">
      <AdaPlanToPose orig_pos="{orig_pos}" orig_quat="{orig_quat}"
         pos="{pos}" quat="{quat}" bounds="{bounds}" worldCollision="{worldCollision}" traj="{traj}" />
      <AdaExecuteTrajectory traj="{traj}" />
    </Sequence>
  </BehaviorTree>


  <!-- Bite Acquisition -->
  <BehaviorTree ID="AcquisitionAction">
  <Sequence name="AcquisitionSeq">
    <!-- Scripting constants -->
    <Script code=" TRUE:=true " />
    <Script code=" FALSE:=false " />

    <!-- Move Above -->
    <!-- <SetFTThreshold preset="standard" /> -->
    <ConfigMoveAbove objects="{foods}" action="{action}" orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" />
    <SubTree ID="MoveToPose" orig_pos="{food_pos}" orig_quat="{food_quat}" pos="{pos}" quat="{quat}" bounds="{bounds}" worldCollision="{TRUE}" />

    <!-- Try Redetect Foods -->
    <ForceSuccess>
      <PerceiveFood name_filter="{food_name}" timeout="1" objects="{foods}" />
    </ForceSuccess>

    <!-- Move Into -->
    <RosGetD param="move_into/overshoot" target="{overshoot}" />
    <ConfigMoveInto objects="{foods}" overshoot="{overshoot}" offset="{offset}" />
    <!-- <SetFTThreshold preset="grabFood" /> -->
    <!-- FT Sensor Trip is Okay -->
    <AdaPlanToOffset name="PlanOffsetInto" offset="{offset}" worldCollision="{FALSE}" traj="{traj}" />
    <ForceSuccess><AdaExecuteTrajectory name="MoveInto" traj="{traj}" /></ForceSuccess>

    <!-- Move Out -->
    <RosGetVecD param="move_out/offset" target="{offset}" />
    <!-- <SetFTThreshold preset="afterGrabFood" /> -->
    <SubTree ID="MoveToOffset" offset="{offset}" worldCollision="{FALSE}" />

    <!-- Check Acquisition -->
    <RosSubBool topic="check_acquire" target="{acquired}" />
    <!-- <SetFTThreshold preset="standard" retare="true" /> -->
    <Failure _successIf="acquired==true" />
  </Sequence>
  </BehaviorTree>
</root>